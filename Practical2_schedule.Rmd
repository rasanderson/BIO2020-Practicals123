---
title: "Practical 2: Linear models and ANOVA"
author: "BIO2020"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

```{r, echo = FALSE, message=FALSE,warning= FALSE}
library(dplyr)
library(palmerpenguins)
library(ggformula)
library(mosaic)
```

# Introduction
In this practical you will be introduced to **linear models** which provide a way to assess the relationships between a **response** variable and one or more **explanatory** variable(s). When plotting your data, the response variable is typically placed on the vertical (y) axis, and the explanatory on the horizontal (x) axis. We are thus sticking with our philosophy of

$$\text{goal(response variable ~ explanatory variable(s), data=dataset, ...)}$$
except that now your goal is a linear model. You can access a linear model using the `lm()` function in R/RStudio. The main aim of this practical are to show you how to use the `lm()` function, using datasets that you will already have seen on the interactive websites at [](https://naturalandenvironmentalscience.shinyapps.io/linear_explan/) and [](https://naturalandenvironmentalscience.shinyapps.io/categorical_explan/). You will also have the opportunity to gain confidence using linear models with a new dataset. Specific objectives are to:

1. understand how to interpret results from linear models with continuous explanatory variables
2. learn the use of linear models with categorical explanatory variables
3. practice using multiple comparison tests, to compare different treatment levels
4. explore these ideas with a new dataset.

Inherent in the idea of linear models is the idea of cause and effect, i.e. your explanatory variables cause some sort of change in your response variable. How do you know which is the response and which is the explanatory? In a "designed experiment", e.g. a laboratory experiment or field plot experiment, the response and explanatory is usually obvious, but sometimes it is less obvious. Take the following examples:

| Response | Explanatory |
|:---------:|:-----------:|
| Plant pathogen gene regulation | Fungicide concentration (mg/l) |
| Mean bird population size | Habitat type (Garden, Arable, Woodland, Heath) |
| Pollinator diversity | Wildflower diversity |

All linear models have a continuous response variable. By "continuous" the response can be any number (3.4, 1.9, -3 etc., rather than Yes/No, Dead/Alive, or only whole numbers permitted). In the above 3 examples note the following:

* the gene regulation has a continuous explanatory fungicide concentration
* the average bird population at a site across all surveys has a categorical explanatory habitat type, with four 'levels'
* Pollinator diversity and wildflower diversity are both continuous. I think it is reasonable to assume that the biodiversity of wildflowers will have a big effect on the pollinators out there, so I've listed wildflower diversity as the explanatory variable. However, some scientists have shown that if the pollinator biodiversity declines sharply, this has a negative effect on the biodiversity of some wildflowers. So in this example the response and explanatory terms are a little more ambiguous.

# 1. Linear models with continuous explanatory variables
## 1.1. Download data and calculate simple statistics
We will start by looking at the `caterpillars` data set that we were using in the interactive website for linear models with continuous explanatory variables. The `caterpillars.csv` data are available on Canvas and should be downloaded and saved in you BIO2020 `Data` folder. After you have downloaded the file:

* Open up the `caterpillars.csv` file in Microsoft Excel to have a quick look at it, but ignore any requests to save it in Excel format.
* Create a new R script, in either Notepad (RGui for Windows), TextEdit (RGui MacBook) or the RStudio script editor (Windows or Mac) and call it `Practical_1.R`. **Note**: Write a suitable comment after a `#` symbol at the top of your script to explain what it is going to do.
* Write the line `library(bio2020)` in the script, and run it, to activate all the necessary add-on R packages.

We need to load the data into R and store it in an object so we can access it easily.

```{r}
caterpillar_dat <- read.csv("Data/caterpillars.csv")
```

If RGui or RStudio does not find the file `caterpillars.csv` check that there are no spelling errors and that your session is in the right place. If you are using RGui you need to manually

Using the functions that you learned in the first practical familiarise yourself with the `caterpillars` data. 

```{r, eval= FALSE}
# see the first 6 rows of the data frame
head(caterpillar_dat)
# check the dimensions of the data frame (numbers of rows and columns)
dim(caterpillar_dat)
```

We can see that this data set contains 2 continuous variables; growth and tannin. What is the mean, minimum, maximum value of these two variables (look back to Practical 1 if you have forgotten how to obtain these data).

## 1.2 Simple visualisation of caterpillar data
In general it is a good idea to plot your data, to gain an understanding of its characteristics, before running a linear model. As you have two fairly simple variables, a scatter plot with our explanatory variable of tannin on the x axis and growth on the y axis will do.

```{r echo = FALSE}
gf_point(growth~tannin, data = caterpillar_dat)
```

From this plot can you estimate:

 + Will the intercept of the fitted line be positive or negative? Recall that the intercept is the value of the y-axis where your fitted line crosses it when the x-axis is zero.
 + Roughly what do you think the value of the intercept is?
 + Will the gradient of the fitted line be positive or negative?

It is always worth doing this visualisation step. Sometimes you will see your scatter of points form a distinct curve, in which case your linear model might need both $x$ and $x^2$ explanatory variables to fit a curve rather than a straight line. It may seem odd that you can fit curves with linear models. The word "linear" simply refers to the fact that you add the various terms together.

## 1.3 Linear model of caterpillar growth data
Now create a linear model to see if our expectations were correct. You will remember from the tutorial that the standard syntax for a linear model is 

`lm(response_variable ~ explanatory_variable, data = dataframe_name)`

Create a linear model for the relationship between tannin and caterpillar growth, storing the output of the linear model in an R object called `growth_lm`. Hints:

* The function that we use in R is `lm()` 
* To the left of your ~ put your response variable, to the right the explanatory
* use the `<-` symbols to assign the results of your linear model to `growth_lm`

```{r, echo = FALSE}
growth_lm <- lm(growth~tannin, data = caterpillar_dat)
```

Now that you have created your linear model, use the `summary()` function to investigate the outputs of your linear model 

```{r}
summary(growth_lm)
```

Were your expectations correct? Using the summary information from your model answer the following questions:

 + What is the intercept of the fitted line?
 + What is the gradient of the fitted line?
 + Is the relationship between the explanatory and response variable significant? 
 + What proportion of the response value can be explained by the explanatory value?  <!--adjusted rsquared--> 
 + Using the `sqrt()` function can you calculate the correlation coefficient between the variables? <!--sqrt(adjusted r2)-->
 + Is the overall model significant?  <!--Fstatistc-->
 + What are the p-values for the intercept and slope. How would you write 

### A note on t-statistics
You will see in the above summary table a column headed `t value`. A brief description of the rather strange t-distribution can be found on the first few pages of [](https://naturalandenvironmentalscience.shinyapps.io/Other_tests/) . The t-distribution is like a fat-tailed normal distribution, and of particular value is the one-sample t-test. This checks whether an estimated value, here your Intercept and slope, is different to zero. If the p-value is **low** then there is a **high probability** that your estimate is **not** zero.
 
## 1.4 Plotting the fitted line

Add the fitted line from the linear model to your scatterplot using the `gf_lm()` function

Remember that when adding a layer to your plot you will need to use the pipe ` %>% ` which can be created using the keyboard shortcut *Ctrl* + *shift* + *m* (*cmd* + *shift* + *m* on mac)

Using the lessons learned in the last practical can you improve the plot. First, add one extra lines using the `%>%` symbol to add the fitted line. Then a second to change the axis labels. Then a third to get rid of the grey background. Finally tweak the second line to change the colour of the fitted line. Re-run the lines of commands each time to watch your graph gradually improve in quality.

1. Add a fitted line using `gf_lm()`
2. Change the axis labels. Hint: `gf_labs()`
3. Removing the grey plot background. Hint: `gf_theme()` with `theme_minimal()`
4. Changing the colour of the fitted line to blue. Hint: add a `colour=` option to `gf_lm()`

Refer back to your script from the previous practical if you need a reminder of how to do this. You should end up with a graph similar to this:

```{r echo = FALSE}
gf_point(growth~tannin, data = caterpillar_dat) %>% 
        gf_lm(colour = "blue") %>% 
        gf_labs(x = "Tannin", y = "Growth") %>%                
        gf_theme(theme_minimal())
```

I also quite like the "classic" rather than "minimal" theme. Once you have your R commands working, try changing `theme_minimal()` to `theme_classic()` to see the difference.

## 1.5 Calculate predicted values of growth for new values of tannin 

You will remember from the tutorial that the fitted or "predicted" values are those along the straight line that you have plotted using `gf_lm()` and that these values are stored in the model output under the `fitted.values` option which you can access by typing `growth_lm$fitted.values` once you have created your model object.

Using the model that you have created you need to determine the fitted value for a caterpillar with a tannin level of **3.5**

Remember that you can use R as a calculator to work out the fitted value using the formula:

`intercept + (gradient * new value)`

or

`intercept - (gradient * new value)`

if the gradient is negative 

Check that your calculation is correct by using the `makeFun()` function  to create a function called `predictor`
The argument to your `makeFun()` function will be the name of your model
Check the predicted value by giving your new `predictor()` function the new input value of 160mm

```{r}
growth_lm <- lm(growth~tannin, data = caterpillar_dat)
predictor <- makeFun(growth_lm)
predictor(3.5)
```

Are the values that you obtained the same?
If the values are not exactly the same can you think why that might be? <!--rouding outputs from summary of model-->

### Checking the assumptions of the model 

You will remember from the tutorials that one of the key assumptions of linear models is that the residuals are from a normal distribution. 

You can extract the residuals using the `residuals()` function which takes the argument of your model object. 
Assign the extracted residuals to a variable so that you can plot them.
Plot a histogram of the residuals using the `gf_histogram()` function, remember when plotting a single variable you can use the formula `gf_histogram(~variable)` 
You will note here that you don't need to specify the data because in this case the variable is stored as single vector rather than within a data frame.

```{r}
#Extract residuals and assign them to an object
res <- residuals(growth_lm)
gf_histogram(~res)
```

A simpler way of checking the distribution of the residuals is to use a QQ plot, we can use the `gf_qq()` function to plot the residual data sorted from highest to lowest and we can add the theoretical expectation using `gf_qqline()` function. 

```{r}
gf_qq(~res) %>%
  gf_qqline()
```


**Write a paragraph to explain the results, what does the model tell you about the relationship between the two variables, is the assumption of normal residuals met? Refer to the figures that you have generated to explain your results.**

# Categorical explanatory variable

We have just run through a model where the explanatory variable was continuous, however there are often cases where we want to investigate categorical variables.

Now let's look at the `crop growth` data set. This data is also available to download from canvas and should be stored in your Data folder. Load it in the same way as the `caterpillars` data set and investigate its variables and structure. 

```{r}

crop_growth <- read.csv("Data/crop_growth.csv")

head(crop_growth)

dim(crop_growth)
```

This time we have one continous variable `yield`, and one categorical variable `soil`.

Lets look at `soil` as an explanatory variable and use `soil` as our response variable.

### Explore the data

Let's start by calculating some summary statistics for each type of soil, remember that the easiest way to do this is to use functions from the `r emo::ji("package")` `mosaic` package. 
To do this you will need to load the package using the `library()` function.

 + Calculate the mean (and sd) weight for each species 
 + Create a boxplot or even better a violin plot that shows the distribution of the weight data for each species 
 
```{r, echo = FALSE}

gf_violin(yield~soil, data = crop_growth) %>% 
  gf_sina(colour = ~soil, alpha = 0.3) %>%
  gf_labs(x = "Soil type", y = "Crop yield") %>% 
   gf_refine(scale_color_manual(values = c("darkorange", "purple", "cyan4"))) %>%
  gf_theme(theme_minimal())
```
 
### Analyse and interpret the linear model 

Using the `lm()` function and the same syntax as with a continuous variable create a linear model.
Summarise the model results using the `anova()` function. 

```{r, echo=FALSE}
#create linear model
soil_lm <- lm(yield ~ soil, data = crop_growth)
#summarise output
anova(soil_lm)
```

Interrogate the differences between species using the `summary()` function and compare the different species using the *Tukey Honest Significant Difference* test

```{r, eval = FALSE}
TukeyHSD(soil_lm)
plot(TukeyHSD(soil_lm))
```

What do the outputs tell you about the differences between soils?

**Don't forget to check your model assumptions** using a histogram or QQ plot of your residuals.

# A new data set

Download the `penguins` data set from Canvas and save it to your BIO202O Data folder.

```{r, echo = FALSE}

penguins <- read.csv("Data/penguins.csv")

```

Using the methods described above, investigate the relationship between `body mass` and `species`, where species is the explanatory variable and body mass is the response variable. 

You need to:

+ Produce a box plot or violin plot
+ Create a linear model and summarise it
+ Complete a Tukey Honest Significant Difference to look at the differences in body mass between species and plot it
+ Interpret your results

```{r, echo = FALSE, include = FALSE}

gf_violin(body_mass_g~species, data = penguins) %>% 
  gf_sina(colour = ~species, alpha = 0.3) %>%
  gf_labs(x = "Soil type", y = "Crop yield") %>% 
   gf_refine(scale_color_manual(values = c("darkorange", "purple", "cyan4"))) %>%
  gf_theme(theme_minimal())

```

```{r, echo = FALSE, include = FALSE}
penguin_lm <- lm(body_mass_g~species, data = penguins)
anova(penguin_lm)
```

```{r, echo = FALSE, include = FALSE}
TukeyHSD(penguin_lm)
plot(TukeyHSD(penguin_lm))
```

**Finally compile the results from your investigations today and write a short report summarising your findings, include any figures or tables that support your results.**


